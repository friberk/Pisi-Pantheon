From 4e98c932602db9dfd95c77c2ba9224b1c090864b Mon Sep 17 00:00:00 2001
From: Fabio Valentini <decathorpe@gmail.com>
Date: Thu, 11 Mar 2021 14:48:15 +0100
Subject: [PATCH 2/3] Adapt to settings moving to gsettings-desktop-schemas
 (MR!1416 backport)

---
 clutter/clutter/clutter-settings.c | 47 +++++++++++++++---------------
 meson.build                        |  2 +-
 src/backends/meta-input-settings.c | 12 +++-----
 src/core/prefs.c                   |  3 +-
 4 files changed, 29 insertions(+), 35 deletions(-)

diff --git a/clutter/clutter/clutter-settings.c b/clutter/clutter/clutter-settings.c
index acb607b..3037a1e 100644
--- a/clutter/clutter/clutter-settings.c
+++ b/clutter/clutter/clutter-settings.c
@@ -65,7 +65,7 @@ struct _ClutterSettings
   GObject parent_instance;
 
   ClutterBackend *backend;
-  GSettings *xsettings;
+  GSettings *settings;
 
   gint double_click_time;
   gint double_click_distance;
@@ -281,10 +281,10 @@ settings_update_fontmap (ClutterSettings *self,
 }
 
 static void
-get_font_gsettings (GSettings    *xsettings,
+get_font_gsettings (GSettings    *settings,
                     FontSettings *output)
 {
-  /* org.gnome.settings-daemon.GsdFontAntialiasingMode */
+  /* org.gnome.desktop.GDesktopFontAntialiasingMode */
   static const struct
   {
     cairo_antialias_t cairo_antialias;
@@ -297,7 +297,7 @@ get_font_gsettings (GSettings    *xsettings,
     /* rgba=2      */ {CAIRO_ANTIALIAS_SUBPIXEL, 1},
   };
 
-  /* org.gnome.settings-daemon.GsdFontHinting */
+  /* org.gnome.desktop.GDesktopFontHinting */
   static const struct
   {
     cairo_hint_style_t cairo_hint_style;
@@ -311,7 +311,7 @@ get_font_gsettings (GSettings    *xsettings,
     /* full=3   */ {CAIRO_HINT_STYLE_FULL,   "hintfull"},
   };
 
-  /* org.gnome.settings-daemon.GsdFontRgbaOrder */
+  /* org.gnome.desktop.GDesktopFontRgbaOrder */
   static const struct
   {
     cairo_subpixel_order_t cairo_subpixel_order;
@@ -327,7 +327,7 @@ get_font_gsettings (GSettings    *xsettings,
   };
   guint i;
 
-  i = g_settings_get_enum (xsettings, "hinting");
+  i = g_settings_get_enum (settings, "font-hinting");
   if (i < G_N_ELEMENTS (hintings))
     {
       output->cairo_hint_style = hintings[i].cairo_hint_style;
@@ -339,7 +339,7 @@ get_font_gsettings (GSettings    *xsettings,
       output->clutter_font_hint_style = NULL;
     }
 
-  i = g_settings_get_enum (xsettings, "antialiasing");
+  i = g_settings_get_enum (settings, "font-antialiasing");
   if (i < G_N_ELEMENTS (antialiasings))
     {
       output->cairo_antialias = antialiasings[i].cairo_antialias;
@@ -351,7 +351,7 @@ get_font_gsettings (GSettings    *xsettings,
       output->clutter_font_antialias = -1;
     }
 
-  i = g_settings_get_enum (xsettings, "rgba-order");
+  i = g_settings_get_enum (settings, "font-rgba-order");
   if (i < G_N_ELEMENTS (rgba_orders))
     {
       output->cairo_subpixel_order = rgba_orders[i].cairo_subpixel_order;
@@ -370,11 +370,11 @@ get_font_gsettings (GSettings    *xsettings,
 static void
 init_font_options (ClutterSettings *self)
 {
-  GSettings *xsettings = self->xsettings;
+  GSettings *settings = self->settings;
   cairo_font_options_t *options = cairo_font_options_create ();
   FontSettings fs;
 
-  get_font_gsettings (xsettings, &fs);
+  get_font_gsettings (settings, &fs);
 
   cairo_font_options_set_hint_style (options, fs.cairo_hint_style);
   cairo_font_options_set_antialias (options, fs.cairo_antialias);
@@ -386,16 +386,16 @@ init_font_options (ClutterSettings *self)
 }
 
 static gboolean
-on_xsettings_change_event (GSettings *xsettings,
-                           gpointer   keys,
-                           gint       n_keys,
-                           gpointer   user_data)
+on_settings_change_event (GSettings *settings,
+                          gpointer   keys,
+                          gint       n_keys,
+                          gpointer   user_data)
 {
   ClutterSettings *self = CLUTTER_SETTINGS (user_data);
   FontSettings fs;
   gint hinting;
 
-  get_font_gsettings (xsettings, &fs);
+  get_font_gsettings (settings, &fs);
   hinting = fs.cairo_hint_style == CAIRO_HINT_STYLE_NONE ? 0 : 1;
   g_object_set (self,
                 "font-hinting",        hinting,
@@ -410,24 +410,23 @@ on_xsettings_change_event (GSettings *xsettings,
 static void
 load_initial_settings (ClutterSettings *self)
 {
-  static const gchar xsettings_path[] =
-    "org.gnome.settings-daemon.plugins.xsettings";
+  static const gchar *settings_path = "org.gnome.desktop.interface";
   GSettingsSchemaSource *source = g_settings_schema_source_get_default ();
   GSettingsSchema *schema;
 
-  schema = g_settings_schema_source_lookup (source, xsettings_path, TRUE);
+  schema = g_settings_schema_source_lookup (source, settings_path, TRUE);
   if (!schema)
     {
-      g_warning ("Failed to find schema: %s", xsettings_path);
+      g_warning ("Failed to find schema: %s", settings_path);
     }
   else
     {
-      self->xsettings = g_settings_new_full (schema, NULL, NULL);
-      if (self->xsettings)
+      self->settings = g_settings_new_full (schema, NULL, NULL);
+      if (self->settings)
         {
           init_font_options (self);
-          g_signal_connect (self->xsettings, "change-event",
-                            G_CALLBACK (on_xsettings_change_event),
+          g_signal_connect (self->settings, "change-event",
+                            G_CALLBACK (on_settings_change_event),
                             self);
         }
     }
@@ -442,7 +441,7 @@ clutter_settings_finalize (GObject *gobject)
   g_free (self->xft_hint_style);
   g_free (self->xft_rgba);
 
-  g_clear_object (&self->xsettings);
+  g_clear_object (&self->settings);
 
   G_OBJECT_CLASS (clutter_settings_parent_class)->finalize (gobject);
 }
diff --git a/meson.build b/meson.build
index 2604ec9..f1fb263 100644
--- a/meson.build
+++ b/meson.build
@@ -24,7 +24,7 @@ uprof_req = '>= 0.3'
 pango_req = '>= 1.2.0'
 cairo_req = '>= 1.10.0'
 pangocairo_req = '>= 1.20'
-gsettings_desktop_schemas_req = '>= 3.37.2'
+gsettings_desktop_schemas_req = '>= 40.alpha'
 json_glib_req = '>= 0.12.0'
 upower_glib_req = '>= 0.99.0'
 xcomposite_req = '>= 0.4'
diff --git a/src/backends/meta-input-settings.c b/src/backends/meta-input-settings.c
index 8bfc950..807c790 100644
--- a/src/backends/meta-input-settings.c
+++ b/src/backends/meta-input-settings.c
@@ -73,7 +73,6 @@ struct _MetaInputSettingsPrivate
   GSettings *touchpad_settings;
   GSettings *trackball_settings;
   GSettings *keyboard_settings;
-  GSettings *gsd_settings;
   GSettings *keyboard_a11y_settings;
   GSettings *mouse_a11y_settings;
 
@@ -159,7 +158,6 @@ meta_input_settings_dispose (GObject *object)
   g_clear_object (&priv->touchpad_settings);
   g_clear_object (&priv->trackball_settings);
   g_clear_object (&priv->keyboard_settings);
-  g_clear_object (&priv->gsd_settings);
   g_clear_object (&priv->keyboard_a11y_settings);
   g_clear_object (&priv->mouse_a11y_settings);
   g_clear_object (&priv->input_mapper);
@@ -2068,6 +2066,10 @@ meta_input_settings_init (MetaInputSettings *settings)
   g_signal_connect (priv->mouse_settings, "changed",
                     G_CALLBACK (meta_input_settings_changed_cb), settings);
 
+  g_settings_bind (priv->mouse_settings, "double-click",
+                   clutter_settings_get_default(), "double-click-time",
+                   G_SETTINGS_BIND_GET);
+
   priv->touchpad_settings = g_settings_new ("org.gnome.desktop.peripherals.touchpad");
   g_signal_connect (priv->touchpad_settings, "changed",
                     G_CALLBACK (meta_input_settings_changed_cb), settings);
@@ -2080,12 +2082,6 @@ meta_input_settings_init (MetaInputSettings *settings)
   g_signal_connect (priv->keyboard_settings, "changed",
                     G_CALLBACK (meta_input_settings_changed_cb), settings);
 
-  priv->gsd_settings = g_settings_new ("org.gnome.settings-daemon.peripherals.mouse");
-
-  g_settings_bind (priv->gsd_settings, "double-click",
-                   clutter_settings_get_default(), "double-click-time",
-                   G_SETTINGS_BIND_GET);
-
   priv->keyboard_a11y_settings = g_settings_new ("org.gnome.desktop.a11y.keyboard");
   g_signal_connect (priv->keyboard_a11y_settings, "changed",
                     G_CALLBACK (meta_input_keyboard_a11y_settings_changed), settings);
diff --git a/src/core/prefs.c b/src/core/prefs.c
index 3dc194a..41e93c9 100644
--- a/src/core/prefs.c
+++ b/src/core/prefs.c
@@ -68,8 +68,7 @@
 #define SCHEMA_MUTTER          "org.gnome.mutter"
 #define SCHEMA_INTERFACE       "org.gnome.desktop.interface"
 #define SCHEMA_INPUT_SOURCES   "org.gnome.desktop.input-sources"
-#define SCHEMA_XSETTINGS       "org.gnome.settings-daemon.plugins.xsettings"
-#define SCHEMA_MOUSE           "org.gnome.settings-daemon.peripherals.mouse"
+#define SCHEMA_MOUSE           "org.gnome.desktop.peripherals.mouse"
 
 #define SETTINGS(s) g_hash_table_lookup (settings_schemas, (s))
 
-- 
2.30.2

